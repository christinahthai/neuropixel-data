---
title: "Assessing Relationship Among Brain Regions in Mice"
output:
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: yes
  pdf_document: default
---

<style type="text/css">
body{ /* Normal  */
      font-size: 14px;
  }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)
```


Team ID: 5

Name (tasks): Oscar Alvardo

Name (tasks): Karshima Johnson

Name (tasks): Christina Thai (Introduction, Background, Summary of Data, Visual of Probe Locations in Brain, Time Series Visual of Average Number of Neurons/Region, Kendall Tau's correlation)


Auditor (tasks):

***

## Introduction
This document is the final report for the Spring 2019 course STA 141A at University of California, Davis. It seeks to examine whether activity in one region affects the activity in another region. 

To reduce the variability of cortical responses to sensory stimuli, analyzing the neural spikes in multiple brain regions during spontaneous activity will yield more accurate, less noisy, results. 

Using the data gathered from contributors Nick Steinmetz, Marius Pachitariu, Carsen Stringer, Matteo Carandini, and Kenneth Harris' experiment, we seek to analyze the areas of the brain that are used in conjunction, regardless of stimuli. The original experiment investigates fluctuations in arousal levels indicated by running, pupil area, and whisking. Our variable of interest is the cortical responses as these behaviors are ongoing. 



## Background
```{r, message = FALSE, include=FALSE}
library("R.matlab") # Install 'R.matlab' if this is the first time you call it.
# Below VV Will vary depending on the local pathway for each computer
ephysroot = '/Users/christinathai/Desktop/R_programming/STA_141A/Project/'; #path of the data set 
mstr = 'Krebs'; # mouse names
### Load saved data:
exp_data<- readMat(paste(ephysroot,mstr,'_reduced.mat',sep=''));
# Check out data structure
str(exp_data)
```


In this project, we analyze the reduced data set `Reduced_Krebs.mat` containing Neuropixel recordings of a mouse named Krebs during spontaneous activity. The full data set can be found at this [webpage](https://janelia.figshare.com/articles/Eight-probe_Neuropixels_recordings_during_spontaneous_behaviors/7739750).

The data used has already been preprocessed using a Matlab script, which can be found in the code Appendix of the report. 


#Summary of Data
This report focuses on data collected from an experiment done with a mouse named Krebs. The neuron activation recorded from stimuli from whisking (measured by summed videographic motion energy within the whisker region).

This data set contains [spike trains](https://en.wikipedia.org/wiki/Neural_coding) of neurons in nine regions in the mouse brain.

The following represent elements of behavior data:
`avgframe` Average Frame of Recording <br />
`faceSVD` Singular Value Decompositon of Compressed Image of Face <br />
`motionMask` Corresponding Masks to Singular Values <brv/>

The data set being referenced `Reduced_Krebs.mat` contains the first 50 singular values and their masks. These are used to reproduce an image based on the average of the frames within the data set using infrared camera. 


The following columns represent the nine regions for Kreubs in the mouse brain:

`stall.CP` Caudate Putamen <br />
`stall.FrMoCtx` Frontal Motor Cortex<br />
`stall.HPF` Hippocampal Formation<br />
`stall.LS` Lateral Septum<br />
`stall.MB` Midbrain<br />
`stall.SC` Superior Colliculus<br />
`stall.SomMoCtxx` Somatomotor Cortex<br />
`stall.TH` Thalamus<br />
`stall.V1` Primary Visual Cortex <br />

The data set contains spike trains of neurons in nine regions of the mouse brain. Each corresponding column represents a specific region of the brain; for example, the vector `stall.CP` relates to the activity and activation of neurons located in the Caudate Putamen.

A more in depth explanation on the structure of our data is that it is a binary matrix with values of 1 denoting an existance of neural activity and 0 being that there is no neural activity at the specific time frame. Each row represents a neuron within the region. 


## Visual of Brain Regions
```{r, fig.width=50, fig.height=50,echo=FALSE}
#Image for the regions of the brain
library(png)
library(grid)
img <- readPNG("/Users/christinathai/Desktop/R_programming/STA_141A/Project/mouse_brain.png")
 grid.raster(img)
```
The figure above is the reconstructed probe locations of recordings in Krebs. The poles are generated using the borders of the brain regions and map depth of the region in microns relative to position of the principal axes of the body (AP/DV/LR). 

**Note:** AP refers the antero-posterior, DV refers to the dorso-ventral, and LR refers to the left-right axis formation.


```{r, echo = FALSE, eval = TRUE, message = FALSE}
brain_regions= ls(exp_data)[-c(1:3)]; 
n_time= dim(exp_data$faceSVD)[2];
n_sv = dim(exp_data$faceSVD)[1];
```

## Statistical questions of interest

We wish to examine which brain regions are being are activated(?) relatively simultaneously. In other words, we seek to examine if brain activity in the Thalamus can also imply activity in the Primary Visual Cortex.

Additionally, we want to examine neural activity throughout the entire time period and locate where there may be significant changes in neural activity.


# Analysis Plan

## Population and study design

The initial study monitored large populations of neurons in awake head-fixed mice. These mice were unengaged from behavioral task and then their spontaneously performed behaviors (i.e. whisking, sniffing, and other facial movements) were monitored videographically. The study recorded simultaneous neurological data of six mice over nine sessions and worked to identify the relationship between these behaviors and their neural activity.  

Further, the studies were testing in various settings such as with and without darkness and recordings in darkness or with a gray screen. They observed no differences between these recordings, thus we take it to imply that Krebs' sample data is representative of the mouse's overall behavior in this experiment[.](https://www.biorxiv.org/content/biorxiv/early/2018/04/22/306019.full.pdf) 

In addition, we acknowledge that mouse models for genetic research prove to be excellent tools for insight into immune, endocrine, cardiovascular, skeletal, and in particular, nervous systems shared by mammals[.](https://www.genome.gov/10005834/background-on-mouse-as-a-model-organism) Thus conclusions obtained through the study may become applicable to humans.  

##Kendall Tau's Correlation
We choose to examine the pairwise correlations with Kendall's method with ranks since this method does not need any assumptions on the distribution. This non-parametric correlation method measures the number of discordant and concordant pairs.
Assume there are pairs $(X_i, Y_i)$ and $(X_j,Y_j)$ where $i < j$. If $X_i < X_j$ and $Y_i < Y_j$, then $(X_i - X_j) \times (Y_i - Y_j) > 0$ and $(X_i, Y_i)$ and $(X_j,Y_j)$. Thus $(X_i, Y_i)$  $(X_j,Y_j)$ is a concordant pair and an increase in X implies an increase in Y.
Similar logic is applied to the definition of discordant pairs, which can be seen in the mathematical definition: $(X_i - X_j) \times (Y_i - Y_j) < 0$. Tied pairs mean $(X_i - X_j) \times (Y_i - Y_j)  = 0$
Kendall's $\tau = \frac{C - D}{n(n-1)/2)}$, where C is the number of concordant pairs and D represents discordant pairs.
If most pairs are concordant, then there is a postive linear relationship. Similarly, if most pairs are discordinant, then the data suggests a negative linear relationship. If there are an equal number of discordant and concordant pairs, this suggests no linear relationship, i.g. X and Y are independent. 



#Results

##Descriptive Anaysis

-- Karishma will add (summary of data) !!!!!!!!!!!!!!!!!!!!!!!!!!!!


```{r}
spikes <- list()
spike_trains <- list()
#Code for extracting the spike trains
getspike <- function(i_region, t1, t2) {
  
    time_range = c(t1,t2)
      
  ### Extract the spike train for this region
  spikes_this_region = exp_data[[brain_regions[i_region]]]
  n_neurons = dim(spikes_this_region)[1]; 
  
  for(i_neuron in 1:n_neurons) {
        spk_times=which(spikes_this_region[i_neuron,time_range[1]:time_range[2]]>0);
        
        spikes[i_neuron] <- list(spk_times);
  }
  
  spike_trains[[i_region]] <- spikes[1:n_neurons]
  
  return(spike_trains)
}
for (i in 1:9) {
  spikes = getspike(i,0,n_time)
}
```
##Reduced SVD Face
```{r eval=FALSE, include=FALSE}

time_list = c(10800:25000) # ADJUST IF YOU'RE NOT CONFIDENT IT WORKS YET # 39053 IS A LOT OF FRAMES TO MAKE 
# I.E. IT TAKES TIME
dims=dim(exp_data$motionMask);

jpeg("/tmp/foo%02d.jpg")
my.plot <- list() #create empty list to store all the images
for (it in 1:length(time_list)){
  face_i = matrix(0,nrow=dims[1],ncol=dims[2]);
  i=time_list[it];
  
  for (i_sv in 1:n_sv){
    tmp=exp_data$motionMask[,,i_sv];
    tmp[is.nan(tmp)]=0;
    face_i=face_i+exp_data$faceSVD[i_sv,i]*tmp;
    
  }
  face_i= apply(face_i, 2, rev) #flips image (haha rev =reverse gottem)
  image <- image( t(face_i),col=heat.colors(20),zlim=c(-10,10)) #plots it
  my.plot[[it]] <- image
  
}
dev.off()

```

##Average Number of Neurons
```{r, echo = FALSE, warning = FALSE}
avg_neuron_list <- vector('list',9)
var_neurons_list <- vector('list', 9)

# par(mfrow = c(4,1))
for (i in 1:9) {
#Calculating the column sums 
spiketrain = exp_data[[brain_regions[i]]];
n_time = dim(spiketrain)[2]
n_neurons = dim(spiketrain)[1]
#Calculating the average number of neurons for each time frame
neurons_fired = colSums(spiketrain)
neurons.avg <- as.vector(neurons_fired/n_neurons)
neurons.var <- var(neurons.avg)
var_neurons_list[[i]] <- neurons.var
avg_neuron_list[[i]] <-neurons.avg
# plot(as.ts(neurons.avg), xlab = "Time Frame", ylab = "Average number of neurons Fired")
}
```


Recall that the brain regions are:
`stall.CP` Caudate Putamen <br />
`stall.FrMoCtx` Frontal Motor Cortex<br />
`stall.HPF` Hippocampal Formation<br />
`stall.LS` Lateral Septum<br />
`stall.MB` Midbrain<br />
`stall.SC` Superior Colliculus<br />
`stall.SomMoCtxx` Somatomotor Cortex<br />
`stall.TH` Thalamus<br />
`stall.V1` Primary Visual Cortex <br />
```{r}
library(dygraphs)
spike_data_frame = data.frame(time = (1:n_time), CP = avg_neuron_list[[1]], FrMoCtx = avg_neuron_list[[2]], HPF = avg_neuron_list[[3]], LS = avg_neuron_list[[4]], MB = avg_neuron_list[[5]], SC = avg_neuron_list[[6]], SoMoCtxx = avg_neuron_list[[7]], TH = avg_neuron_list[[8]], V1 =  avg_neuron_list[[9]])
dygraph(spike_data_frame) %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors=c("#a987b7", "#59bad8", "#D8AE5A","#9b2b2b", "#8fb787", "#096010", "#0c62b7", "#f4b7f1", "#ff0008")) %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 8, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 300)
```



From the above plot, we can see that the time from of most activity is between 20000 and 29000ms. Thus, we adjust our interval accordingly to analyze correlation.

We choose to examine correlation using the Kendall method. 


##Correlation Analysis
We choose to examine correlation using the Kendall method because it does not require the assumption of a linear relationship. 
Another reason why we chose to use Kendall Tau's method for correlation because the ranking of data points mitigates the effects of outliers. 
```{r}
library(ggcorrplot)
library(corrplot)

#Time frame of interest
time_frame <- c(20000:29000)

for (i in 1:9) {
  spikes[[i]] <- avg_neuron_list[[i]][time_frame]
}

spikes.cor.data = data.frame(CP = spikes[[1]], FrMoCtx = spikes[[2]], HPF = spikes[[3]], LS = spikes[[4]], MB = spikes[[5]], SC = spikes[[6]], SoMoCtxx = spikes[[7]], TH = spikes[[8]], V1 =  spikes[[9]])

#Computing Kendall's correlation matrix
spikes.cor.kendall <- cor(spikes.cor.data, method = "kendall")

#Computing Pearson's correlation
spikes.cor.pearson <- cor(spikes.cor.data)

```



```{r}
#Plot Pearson Correlation Matrix
corrplot(spikes.cor.pearson, method = "number", type = "lower")
```


```{r}
#Plot Kendall Tau Correlation Matrix
corrplot(spikes.cor.kendall, method="number", type = "lower")
```
Kendall's correlation is much smaller value, which we believe is due to removing 


# Discussion
Note: Discuss the limitations of the presented projects, and comment on how this project enlightens future research or analysis.



# Session information
```{r}
print(sessionInfo(), local = FALSE)
```
