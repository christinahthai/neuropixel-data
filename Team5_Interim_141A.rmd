---
title: "Assessing Regulatory Relationship Between Brain Regions during Spontaneous Activity: Interim Report"
output:
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: yes
  pdf_document: default
---

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)
```


Team ID: 5

Name (tasks): Oscar Alvarado (..)

Name (tasks): Karishma Johnson (Spike Trains, Krebs' Visual)

Name (tasks): Christina Thai (Summary of data, Generated Mouse Brain .png, ..)


***



# Introduction

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! (maybe small expansion)

This document is the interim report for STA 141A, Spring 2019. It seeks to examine whether their exists a regulatory relationship among regions. In other words, we will be investigating if activity in one region affects the activity in another region. 

To reduce the variability of cortical responses to sensory stimuli, analyzing the neural spikes in multiple brain regions during spontaneous activity will yield more accurate, less noisy, results. 

Using the data gathered from contributors Nick Steinmetz, Marius Pachitariu, Carsen Stringer, Matteo Carandini, and Kenneth Harris' experiment, we seek to analyze the areas of the brain that are used in conjunction, regardless of stimuli. The original experiment investigates fluctuations in arousal levels indicated by running, pupil area, and whisking. Our variable of interest is in the cortical responses as these behaviors are ongoing. 



## Background
```{r, message = FALSE, include=FALSE}
library("R.matlab") # Install 'R.matlab' if this is the first time you call it.

# Below VV Will vary depending on the local pathway for each computer
ephysroot = '/Users/christinathai/Desktop/R_programming/STA_141A/Project/'; #path of the data set 

mstr = 'Krebs'; # mouse names

### Load saved data:
exp_data<- readMat(paste(ephysroot,mstr,'_reduced.mat',sep=''));

# Check out data structure
str(exp_data)
```


In this project, we analyze the reduced data set `Reduced_Krebs.mat` containing Neuropixel recordings of a mouse named Krebs during spontaneous activity. The full data set can be found at this [webpage](https://janelia.figshare.com/articles/Eight-probe_Neuropixels_recordings_during_spontaneous_behaviors/7739750).

The data used has already been preprocessed using a Matlab script, which can be found in the code Appendix of the report. 


#Summary of Data
This report focuses on data collected from an experiment done with a mouse named Krebs. The neuron activation recorded from stimuli from running (measured by the motion of the air floating ball), whisking (measured by summed videographic motion energy within the whisker region), and the pupil area.

This data set contains [spike trains](https://en.wikipedia.org/wiki/Neural_coding) of neurons in nine regions in the mouse brain.

The following represent elements of behavior data
`avgframe` Average Frame of Recording
`faceSVD` Singular Value Decompositon of Compressed Image of Face
`motionMask` Corresponding Masks to Singular Values

The data set being referenced `Reduced_Krebs.mat` contains the first 50 singular values and their masks. These are used to reproduce an image based on the average of the frames within the data set using infrared camera. 

The following represent the nine regions for Krebs in the mouse brain:
`stall.CP` Caudate Putamen
`stall.FrMoCtx` Frontal Motor Cortex
`stall.HPF` Hippocampal Formation
`stall.LS` Lateral Septum
`stall.MB` Midbrain
`stall.SC` Superior Colliculus
`stall.SomMoCtxx` Somatomotor Cortex
`stall.TH` Thalamus
`stall.V1` Primary Visual Cortex

The data set contains spike trains of neurons in nine regions of the mouse brain. Each corresponding column represents a specific region of the brain; for example, the vector `stall.CP` relates to the activity and activation of neurons located in the Caudate Putamen.


## Visual of Brain Regions
```{r, fig.width=50, fig.height=50,echo=FALSE}
#Image for the regions of the brain
library(png)
library(grid)
img <- readPNG("/Users/christinathai/Desktop/R_programming/STA_141A/Project/mouse_brain.png")
 grid.raster(img)
```
The figure above is the reconstructed probe locations of recordings in Krebs. The poles are generated using the borders of the brain regions and map depth of the region in microns relative to position of the principal axes of the body plan (AP/DV/LR). 

**Note:** AP refers the antero-posterior, DV refers to the dorso-ventral, and LR refers to the left-right axis formation.


```{r, echo = FALSE, eval = TRUE, message = FALSE}
brain_regions= ls(exp_data)[-c(1:3)]; 
n_time= dim(exp_data$faceSVD)[2];
n_sv = dim(exp_data$faceSVD)[1];
```

## Statistical questions of interest

To answer the primary scientific question of interest, we wish to assess the relationship between the different brain regions. 



# Analysis Plan
Since our sample size (number of mice in experiment) is extremely small, n = 1, we cpropose to use Kendall Tau Correlation method since it will outperform Pearson and Spearman's. 


Additionally, Kendall's Tau is ideal because it measures the extent to which, as one variable increases, the other variable tends to increase, without requiring the increase to be represented by a linear relationship.


## Population and study design

The initial study monitored large populations of neurons in awake head-fixed mice. These mice were unengaged from behavioral task and then their spontaneously performed behaviors (i.e. whisking, sniffing, and other facial movements) were monitored videographically. The study recorded simultaneous neurological data of six mice over nine sessions and worked to identify the relationship between these behaviors and their neural activity.  


## Statistical Analysis

### Descriptive Analysis


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

<span style="color:red">Note: </span>  Describe the descriptive analysis you plan to conduct on the data set. The goal of the descriptive analysis is to provide an overview of the data set (and the study that collects the data) before diving into the analysis.

We will summarize the distribution of each variables for patients in the treatment group and the control group. Based on the summary statistics, we will evaluate whether the randomization is successful. To be specific, all summary statistics of baseline variables should be similar between the treatment and control groups.

We will estimate the survival function of patients in the treatment and control groups using Kaplan-Meier estimates, without adjusting for any covariates. Furthermore, we will summarize the distribution of observation time and the patients' status at the end of study in groups defined by treatment, regions of patients, indicator that patient had an abnormal LDH level, or indicator that patient had an abnormal alkaline phoshatase level.

### "Main" Analysis


<span style="color:red">Note: </span>  Describe the analysis you plan to conduct to answer the questions of interest. Remember to rename the section title to fit the actual analysis you propose, e.g., inferential analysis, clustering, prediction model, etc. For instance, in this report, this section should explain

* Detailed model specification of linear regression model.
* Description of the Cox proportional hazard model.
* Description of the model with interactions.

Furthermore, this section should also explain how you plan to interpret the conclusion---this is a convention for the analysis of clinical trials, which may not apply to other data science projects.



### Sensitivity Analysis


<span style="color:red">Note: </span>  Describe additional analysis you plan to conduct to complement the main analysis. This section should include analysis to show that the results you get are not sensitive to the model choices or assumptions. You can also conduct analysis to account for features in the data you have not foreseen.  


# Results

## Spike Trains 

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! (KC - interpret)

#### Time Frame Indices 100 to 1000
```{r echo = FALSE,eval = TRUE, message = FALSE}
library(R.matlab) 
library(ggplot2)

plot_list = list()
for(i_region in 1:9) {
      time_range = c(100, 1000); # indices of time frame
      
      ### Extract the spike train for this region
      spikes_this_region = exp_data[[brain_regions[i_region]]]
      
      ### Visualize the spike train 
      n_neurons = dim(spikes_this_region)[1]; 
      p = plot(x=0,y=0,pch=16,col="white",type="l",lwd=3,ylim=c(0,n_neurons),
               xlim=time_range,cex.lab=1,cex.main=1,ylab='Neuron',xlab='Time frame',
               main=paste0("Spike Train Region ", i_region, " Time ", time_range[1], 
                " to ", time_range[2]))
               #yaxt='n',xaxt='n',
      
      for(i_neuron in 1:n_neurons){
        spk_times =which(spikes_this_region[i_neuron,time_range[1]:time_range[2]]>0);
        if (length(spk_times)>0){
          points(y=rep(i_neuron,length(spk_times)),x=spk_times+time_range[1]-1,col="#000000",pch='.',cex=2)
        }
      }
      
      plot_list[[i_region]] = p

}
```

#### Spike Trains for Time Frame Indices 1000 to 2000

```{r echo = FALSE, eval = TRUE, message = FALSE}
plot_list = list()
for(i_region in 1:9) {
      time_range = c(1000, 2000); # indices of time frame
      
      ### Extract the spike train for this region
      spikes_this_region = exp_data[[brain_regions[i_region]]]
      
      ### Visualize the spike train 
      n_neurons = dim(spikes_this_region)[1]; 
      p = plot(x=0,y=0,pch=16,col="white",type="l",lwd=3,ylim=c(0,n_neurons),
               xlim=time_range,cex.lab=1,cex.main=1,ylab='Neuron',xlab='Time frame',
               main=paste0("Spike Train Region ", i_region, " Time ", time_range[1], 
                " to ", time_range[2]))
               #yaxt='n',xaxt='n',
      
      for(i_neuron in 1:n_neurons){
        spk_times =which(spikes_this_region[i_neuron,time_range[1]:time_range[2]]>0);
        if (length(spk_times)>0){
          points(y=rep(i_neuron,length(spk_times)),x=spk_times+time_range[1]-1,col="#000000",pch='.',cex=2)
        }
      }
      
      plot_list[[i_region]] = p

}
```



## Descriptive Analysis


<span style="color:red">Note: </span> There are many ways to automatically generate summary tables in `R`, of which many would even generate html or latex tables. In this template, we will use the package `qwraps2` as an example ([link](https://cran.r-project.org/web/packages/qwraps2/vignettes/summary-statistics.html)).

```{r }
library(dplyr)
library(tidyr)
library(qwraps2)

options(digits = 3)  

set.seed(1) # Read more about RNGs with ?set.seed

### Read data
nsclc_data <- read.table("../Data/nsclc-modified.txt", header = TRUE)

excluded_vars = c("ptid","tx");
table1_summary <-  nsclc_data %>%   select(.,-one_of(excluded_vars)) %>%  qsummary(.)

table1 =nsclc_data %>% group_by(.data$tx) %>%
  summary_table(., table1_summary)

rgroups =   rep(4,length(names(nsclc_data))-2)
names(rgroups)=names(nsclc_data)[!names(nsclc_data)%in%excluded_vars]

qable(table1,markup='markdown',rgroup=rgroups)
```




```{r}
nsclc_data.trt= nsclc_data %>% filter(tx == 1);
nsclc_data.ctrl= nsclc_data %>% filter(tx == 0);
table2_summary.trt <- nsclc_data.trt %>%   select("obstime","survival.past.400") %>%  qsummary(.)
table2_summary.ctrl <- nsclc_data.ctrl %>%   select("obstime","survival.past.400") %>%  qsummary(.)

table2=list();
table2.trt=list();
table2.ctrl=list();
bin_list = c("europe",             "abnLDH","abnAlkphos")
for(i_var in 1:length(bin_list)){
(table2.trt[[i_var]] =nsclc_data.trt %>% group_by(.data[[bin_list[i_var]]]) %>% summary_table(., table2_summary.trt))
(table2.ctrl[[i_var]] =nsclc_data.ctrl %>% group_by(.data[[bin_list[i_var]]]) %>% summary_table(., table2_summary.ctrl))

table2[[i_var]] = cbind(table2.trt[[i_var]],table2.ctrl[[i_var]]);
}
rgroups2 =   rep(4,2)
names(rgroups2)=c("obstime","survival.past.400")
```

```{r}
qable(table2[[1]],markup="markdown",rgroup=rgroups2)
```


```{r}
qable(table2[[2]],markup="markdown",rgroup=rgroups2)
```


```{r}
qable(table2[[3]],markup="markdown",rgroup=rgroups2)
```

## Inferential Analysis



## Sensitivity analysis
 - the study of how the uncertainity in the output of a mathemadical model or system can be divided and allocated to different soures of uncertainity in its inputs



# Future analysis plan 
Since we have analyzed the correlation for each brain region. Another insightful feature to our report would be to create a prediction model to examine the strength of the relationship of spontaneous activity on neural activity. Additionally, incorporating more stimuli can give us a better understanding of how which stimuli triggers activity in specific regions of the brain.

#References

http://dev.biologists.org/content/133/11/2095



# Session information
```{r}
print(sessionInfo(), local = FALSE)
```
