---
title: "Assessing Treatment Effects of TFD725 for Non-small Cell Lung Cancer: Interim Report"
output:
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: yes
  pdf_document: default
---

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)
```


Team ID: 5

Name (tasks): Oscar Alvarado 

Name (tasks): Karishma Johnson 

Name (tasks): Christina Thai


***



# Introduction

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! (maybe small expansion)

This document is the interim report for STA 141A, Spring 2019. It seeks to examine whether their exists a regulatory relationship among regions. In other words, we will be investigating if activity in one region affects the activity in another region. 



## Background
```{r, message = FALSE, include=FALSE}
library("R.matlab") # Install 'R.matlab' if this is the first time you call it.


# Below VV Will vary depending on the local pathway for each computer
ephysroot = '/Users/christinathai/Desktop/R_programming/STA_141A/Project/'; #path of the data set 

mstr = 'Krebs'; # mouse names

### Load saved data:
exp_data<- readMat(paste(ephysroot,mstr,'_reduced.mat',sep=''));

# Check out data structure
str(exp_data)
```


In this project, we analyze the reduced data set `Reduced_Krebs.mat` containing Neuropixel recordings of a mouse named Krebs during spontaneous activity. The full data set can be found at this [webpage](https://janelia.figshare.com/articles/Eight-probe_Neuropixels_recordings_during_spontaneous_behaviors/7739750).
The data used has already been preprocessed using a Matlab script, which can be found in the code Appendix of the report. 

## Cortical Responses to Sensory Stimuli
Cortical responses to sensory stimuli are highly variable, and sensory cortex exhibits intricate spontaneous activity even without external sensory input. Cortical variability and spontaneous activity have been variously proposed to represent random noise, recall of prior experience, or encoding of ongoing behavioral and cognitive variables. Here, by recording over 10,000 neurons in mouse visual cortex, we show that spontaneous activity reliably encodes a high-dimensional latent state, which is partially related to the ongoing behavior of the mouse and is represented not just in visual cortex but across the forebrain. Sensory inputs do not interrupt this ongoing signal, but add onto it a representation of visual stimuli in orthogonal dimensions. Thus, visual cortical population activity, despite its apparently noisy structure, reliably encodes an orthogonal fusion of sensory and multidimensional behavioral information.
***

#Summary of Data
Within the reduced data we have, the columns 


This data set contains [spike trains](https://en.wikipedia.org/wiki/Neural_coding) of neurons in nine regions in the mouse brain.




Each entry in the matrix represents the number of spikes for one neuron in the corresponding time window. 
`faceSVD`
`motionMask`

The nine regions for Kreubs in the mouse brain are:
`stall.CP` Caudate Putamen
`stall.FrMoCtx` Frontal Motor Cortex
`stall.HPF` Hippocampal Formation
`stall.LS` Lateral Septum
`stall.MB` Midbrain
`stall.SC` Superior Colliculus
`stall.SomMoCtxx` Somatomotor Cortex
`stall.TH` Thalamus
`stall.V1` Primary Visual Cortex

The data set contains spike trains of neurons in nine regions of the mouse brain. Each corresponding column represents a specific region of the brain; for example, the Caudate Putamen



```{r, fig.width=50, fig.height=50,echo=FALSE}
#Image for the regions of the brain
library(png)
library(grid)
img <- readPNG("/Users/christinathai/Desktop/R_programming/STA_141A/Project/mouse_brain.png")
 grid.raster(img)
```

```{r}

brain_regions= ls(exp_data)[-c(1:3)]; 
n_time= dim(exp_data$faceSVD)[2];
n_sv = dim(exp_data$faceSVD)[1];
```


## Statistical questions of interest

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

<span style="color:red">Note: </span>  Translate the scientific goals into statistical questions that can be answered with appropriate statistical analysis on the given data.

To answer the primary scientific question of interest, we propose to fit a linear regression with the observation time (from randomization) as the response and the indicator of region, age, indicator of gender, indicator of advanced stage, indicator for whether patient had an abnormal LDH level at time of randomization, indicator whether patient had an abnormal alkaline phosphatase level at time of randomization, and patient's performance on ECOG scale as covariates. To answer the secondary questions of interest, we will use the Cox proportional hazard model to estimate the survival rate, and we will add interaction terms between the treatment indicator and the regions of patients, indicator that patient had an abnormal LDH level, or indicator that patient had an abnormal alkaline phoshatase level.


# Analysis Plan

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

<span style="color:red">Note: </span>  It is best practice to write down the statistical analysis plan before analyzing data. This can significantly improve the rigorousity and reproducibility of the analysis, and avoid false discovery. This section should just be an extended version of your initial proposal. It is often inevitable that one may need to alter the analysis plan for unexpected features in the data. However, detailed documentation of the changes will shed light on unique features of the data set and help future analysis.


## Population and study design
Due to the small 

## Statistical Analysis

### Descriptive Analysis


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

<span style="color:red">Note: </span>  Describe the descriptive analysis you plan to conduct on the data set. The goal of the descriptive analysis is to provide an overview of the data set (and the study that collects the data) before diving into the analysis.

We will summarize the distribution of each variables for patients in the treatment group and the control group. Based on the summary statistics, we will evaluate whether the randomization is successful. To be specific, all summary statistics of baseline variables should be similar between the treatment and control groups.

We will estimate the survival function of patients in the treatment and control groups using Kaplan-Meier estimates, without adjusting for any covariates. Furthermore, we will summarize the distribution of observation time and the patients' status at the end of study in groups defined by treatment, regions of patients, indicator that patient had an abnormal LDH level, or indicator that patient had an abnormal alkaline phoshatase level.

### "Main" Analysis


<span style="color:red">Note: </span>  Describe the analysis you plan to conduct to answer the questions of interest. Remember to rename the section title to fit the actual analysis you propose, e.g., inferential analysis, clustering, prediction model, etc. For instance, in this report, this section should explain

* Detailed model specification of linear regression model.
* Description of the Cox proportional hazard model.
* Description of the model with interactions.

Furthermore, this section should also explain how you plan to interpret the conclusion---this is a convention for the analysis of clinical trials, which may not apply to other data science projects.



### Sensitivity Analysis


<span style="color:red">Note: </span>  Describe additional analysis you plan to conduct to complement the main analysis. This section should include analysis to show that the results you get are not sensitive to the model choices or assumptions. You can also conduct analysis to account for features in the data you have not foreseen.  


# Results

## Spike Trains 

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! (KC - interpret)

#### Time Frame Indices 100 to 1000
```{r echo = FALSE,eval = TRUE, message = FALSE}
library(R.matlab) 
library(ggplot2)

plot_list = list()
for(i_region in 1:9) {
      time_range = c(100, 1000); # indices of time frame
      
      ### Extract the spike train for this region
      spikes_this_region = exp_data[[brain_regions[i_region]]]
      
      ### Visualize the spike train 
      n_neurons = dim(spikes_this_region)[1]; 
      p = plot(x=0,y=0,pch=16,col="white",type="l",lwd=3,ylim=c(0,n_neurons),
               xlim=time_range,cex.lab=1,cex.main=1,ylab='Neuron',xlab='Time frame',
               main=paste0("Spike Train Region ", i_region, " Time ", time_range[1], 
                " to ", time_range[2]))
               #yaxt='n',xaxt='n',
      
      for(i_neuron in 1:n_neurons){
        spk_times =which(spikes_this_region[i_neuron,time_range[1]:time_range[2]]>0);
        if (length(spk_times)>0){
          points(y=rep(i_neuron,length(spk_times)),x=spk_times+time_range[1]-1,col="#000000",pch='.',cex=2)
        }
      }
      
      plot_list[[i_region]] = p

}
```

#### Spike Trains for Time Frame Indices 1000 to 2000

```{r echo = FALSE, eval = TRUE, message = FALSE}
plot_list = list()
for(i_region in 1:9) {
      time_range = c(1000, 2000); # indices of time frame
      
      ### Extract the spike train for this region
      spikes_this_region = exp_data[[brain_regions[i_region]]]
      
      ### Visualize the spike train 
      n_neurons = dim(spikes_this_region)[1]; 
      p = plot(x=0,y=0,pch=16,col="white",type="l",lwd=3,ylim=c(0,n_neurons),
               xlim=time_range,cex.lab=1,cex.main=1,ylab='Neuron',xlab='Time frame',
               main=paste0("Spike Train Region ", i_region, " Time ", time_range[1], 
                " to ", time_range[2]))
               #yaxt='n',xaxt='n',
      
      for(i_neuron in 1:n_neurons){
        spk_times =which(spikes_this_region[i_neuron,time_range[1]:time_range[2]]>0);
        if (length(spk_times)>0){
          points(y=rep(i_neuron,length(spk_times)),x=spk_times+time_range[1]-1,col="#000000",pch='.',cex=2)
        }
      }
      
      plot_list[[i_region]] = p

}
```



## Descriptive Analysis


<span style="color:red">Note: </span> There are many ways to automatically generate summary tables in `R`, of which many would even generate html or latex tables. In this template, we will use the package `qwraps2` as an example ([link](https://cran.r-project.org/web/packages/qwraps2/vignettes/summary-statistics.html)).

```{r }
library(dplyr)
library(tidyr)
library(qwraps2)

options(digits = 3)  

set.seed(1) # Read more about RNGs with ?set.seed

### Read data
nsclc_data <- read.table("../Data/nsclc-modified.txt", header = TRUE)

excluded_vars = c("ptid","tx");
table1_summary <-  nsclc_data %>%   select(.,-one_of(excluded_vars)) %>%  qsummary(.)

table1 =nsclc_data %>% group_by(.data$tx) %>%
  summary_table(., table1_summary)

rgroups =   rep(4,length(names(nsclc_data))-2)
names(rgroups)=names(nsclc_data)[!names(nsclc_data)%in%excluded_vars]

qable(table1,markup='markdown',rgroup=rgroups)
```




```{r}
nsclc_data.trt= nsclc_data %>% filter(tx == 1);
nsclc_data.ctrl= nsclc_data %>% filter(tx == 0);
table2_summary.trt <- nsclc_data.trt %>%   select("obstime","survival.past.400") %>%  qsummary(.)
table2_summary.ctrl <- nsclc_data.ctrl %>%   select("obstime","survival.past.400") %>%  qsummary(.)

table2=list();
table2.trt=list();
table2.ctrl=list();
bin_list = c("europe",             "abnLDH","abnAlkphos")
for(i_var in 1:length(bin_list)){
(table2.trt[[i_var]] =nsclc_data.trt %>% group_by(.data[[bin_list[i_var]]]) %>% summary_table(., table2_summary.trt))
(table2.ctrl[[i_var]] =nsclc_data.ctrl %>% group_by(.data[[bin_list[i_var]]]) %>% summary_table(., table2_summary.ctrl))

table2[[i_var]] = cbind(table2.trt[[i_var]],table2.ctrl[[i_var]]);
}
rgroups2 =   rep(4,2)
names(rgroups2)=c("obstime","survival.past.400")
```

```{r}
qable(table2[[1]],markup="markdown",rgroup=rgroups2)
```


```{r}
qable(table2[[2]],markup="markdown",rgroup=rgroups2)
```


```{r}
qable(table2[[3]],markup="markdown",rgroup=rgroups2)
```

## Inferential Analysis

```{r, cache = TRUE, message=FALSE}
library(lmtest)
library(sandwich)

nsclc_data.lm=lm(obstime~tx+europe+age+male+advdis+response+abnLDH+abnAlkphos+as.factor(ECOG),data=nsclc_data);

nsclc_data.robust_lm=coeftest(nsclc_data.lm, vcov = vcovHC(nsclc_data.lm, type="HC1"))

tmp=matrix(nsclc_data.robust_lm,nrow=dim(nsclc_data.robust_lm)[1],ncol=dim(nsclc_data.robust_lm)[2])
dimnames(tmp)=dimnames(nsclc_data.robust_lm);

caption_text = paste('Table 3: Results of multiple linear regression', sep='')
knitr::kable(
 tmp,  caption = caption_text
)
```



## Sensitivity analysis





# Future analysis plan 



# Session information
```{r}
print(sessionInfo(), local = FALSE)
```
